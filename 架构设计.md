# 2D 板材 CAM 系统架构设计（MVP）

---

## 1. 设计目标

本系统为二维板材切割 CAM 内核，支持：

- 2D 几何建模（Line / Arc / Circle / Polyline）
- **WorkFeature** 结构建模
- 坡口要求（参与**共边**判断）
- 手动排样
- 共边 Level 1（共享 Geometry）
- 刀路生成（内部结构，不包含 GCode 输出）

不支持：

- SubPlan
- 自动排序
- 多机型适配
- 高级策略系统
- GCode 导出

---

## 2. 架构分层

系统分为三个逻辑域：

**设计域 → 工艺规划域 → 制造域**

### 2.1 设计域（Design Domain）

职责：

- 几何表达
- 加工语义表达
- **共边**合法性判断

核心结构：

```
CAMFile
 ├── WorkBlank?
 └── WorkPieceList
```

**WorkBlank**（可选）

```
WorkBlank
 ├── Id
 └── Geometry
```

**WorkPiece**

```
WorkPiece
 ├── Id
 ├── Placement (X, Y, Rotation)
 ├── OuterGeometry
 └── FeatureList
```

说明：

- **Placement** 是排样唯一入口
- 不包含制造信息

**WorkFeature**

```
WorkFeature
 ├── Id
 ├── GeometryList
 ├── FeatureType (Outer / Inner / EdgeGroup)
 └── BevelRequirement?
```

职责：

- 表达加工意图
- 表达坡口要求
- 作为工艺规划输入单元

**BevelRequirement**

```
BevelRequirement
 ├── Enabled
 ├── Angle
 └── Side (Left / Right)
```

重要原则：

- 属于设计层
- 用于**共边**判断
- 不包含执行参数

**WorkGeometry**

```
WorkGeometry
 ├── Id
 ├── Type (Line / Arc / Circle / Polyline)
 └── Parameters
```

说明：

- 可被多个 **WorkFeature** 引用
- **共边**通过共享 Geometry 实现

### 3. 工艺规划域（Planning Domain）

职责：

- 将 Feature 转换为加工步骤
- 合并可**共边** Feature
- 创建 Operation

**WorkPlan**

```
WorkPlan
 └── StepList
```

**WorkStep**

```
WorkStep
 ├── Id
 ├── FeatureRefList
 ├── Operation
 └── RapidLinks
```

约束：

- MVP 中一个 Step 只包含一个 Operation
- Step 不可复用

### 4. 制造域（Manufacturing Domain）

职责：

- 定义加工参数
- 生成刀路

**WorkOperation**

```
WorkOperation
 ├── Tool
 ├── Technology
 └── ToolPath
```

**WorkTool**

```
WorkTool
 ├── ToolType
 └── Parameters
```

**WorkTechnology**

```
WorkTechnology
 ├── CuttingMode
 ├── RealBevelAngle
 ├── Power
 └── Layer
```

说明：

- **RealBevelAngle** 为执行角度
- 可与 Feature.Angle 相同
- 允许未来做补偿

**WorkToolPath**

```
WorkToolPath
 └── GeometrySequence
```

说明：

- 为计算结果
- 不可手动编辑
- 不包含空移

---

## 5. 数据流设计

### 5.1 用户画线

输入：

- `(start, end)`

生成：

- WorkGeometry
- WorkFeature
- 加入 WorkPiece

### 5.2 排样

修改：

- WorkPiece.Placement

原则：

- 不修改 Geometry
- 不修改 Feature

### 5.3 工艺规划

- 遍历所有 WorkFeature
- 判断**共边**条件
- 创建 WorkStep
- 创建 WorkOperation

**共边判断规则**

两个 WorkFeature 可合并的条件：

- 共享同一 WorkGeometry
- BevelRequirement 完全一致

### 5.4 刀路生成流程

对于每个 WorkStep：

- 读取 Feature.Geometry
- 乘以 **Placement** 生成世界坐标
- 执行偏置补偿
- 若存在坡口 → 设置 Technology.RealBevelAngle
- 生成 WorkToolPath
- 挂载到 Operation

---

## 6. 数据关系总图

```
CAMFile
 ├── WorkPiece
 │     └── WorkFeature
 │            ├── Geometry
 │            └── BevelRequirement
 │
 └── WorkPlan
       └── WorkStep
             └── WorkOperation
                   ├── WorkTool
                   ├── WorkTechnology
                   └── WorkToolPath
```

---

## 7. 关键架构原则

### 7.1 单向数据流

`Design → Planning → Manufacturing`

- 不允许反向依赖。

### 7.2 ToolPath 是函数结果

`ToolPath = f(Feature, Placement, Technology)`

- 不可直接编辑。

### 7.3 排样隔离原则

**Placement** 不得污染：

- Geometry
- Feature
- Operation

### 7.4 坡口分层原则

设计层：

- WorkFeature.BevelRequirement

制造层：

- WorkOperation.Technology.RealBevelAngle

### 7.5 共边的本质

- **共边** = 多 Feature 引用同一 Geometry
- 加工语义一致

---

## 8. MVP 可实现能力

- ✔ 手动绘图
- ✔ 手动排样
- ✔ 共边
- ✔ 坡口
- ✔ 刀路生成
- ✔ 支持未来扩展

---

## 9. 扩展预留点

未来可扩展：

- SubPlan
- 自动排序
- 多 Operation Step
- 多刀分层坡口
- GCode 导出
- 机型适配层

当前结构无需重构即可扩展。

---

## 10. 结论

本架构实现了：

- 设计与制造彻底分离
- 排样隔离
- **共边**合法性可判断
- 坡口可参与拓扑决策
- 刀路纯函数生成

该结构为工业级 CAM 内核的最小可实现版本。
